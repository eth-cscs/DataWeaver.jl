<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>2D diffusion simulation with [MPI.jl] and DataWeaver.jl - writing to file · DataWeaver.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://eth-cscs.github.io/DataWeaver.jl/examples/mpi_diffusion2D/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DataWeaver.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../usage/">Usage</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../read_test/">Reading one variable with a pre-configured XML file</a></li><li class="is-active"><a class="tocitem" href>2D diffusion simulation with [MPI.jl] and DataWeaver.jl - writing to file</a></li></ul></li><li><a class="tocitem" href="../../api/">API reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>2D diffusion simulation with [MPI.jl] and DataWeaver.jl - writing to file</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>2D diffusion simulation with [MPI.jl] and DataWeaver.jl - writing to file</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/eth-cscs/DataWeaver.jl/blob/main/docs/src/examples/mpi_diffusion2D.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="D-diffusion-simulation-with-[MPI.jl]-and-[DataWeaver.jl](https://github.com/eth-cscs/DataWeaver.jl)-writing-to-file"><a class="docs-heading-anchor" href="#D-diffusion-simulation-with-[MPI.jl]-and-[DataWeaver.jl](https://github.com/eth-cscs/DataWeaver.jl)-writing-to-file">2D diffusion simulation with [MPI.jl] and <a href="https://github.com/eth-cscs/DataWeaver.jl">DataWeaver.jl</a> - writing to file</a><a id="D-diffusion-simulation-with-[MPI.jl]-and-[DataWeaver.jl](https://github.com/eth-cscs/DataWeaver.jl)-writing-to-file-1"></a><a class="docs-heading-anchor-permalink" href="#D-diffusion-simulation-with-[MPI.jl]-and-[DataWeaver.jl](https://github.com/eth-cscs/DataWeaver.jl)-writing-to-file" title="Permalink"></a></h1><pre><code class="language-julia hljs">using MPI
using ADIOS2
using LinearAlgebra
using Printf
using Statistics
using DataWeaver


function update_halo(A, neighbors_x, neighbors_y)
    if neighbors_x[1] &gt;= 0
        sendbuf = copy(A[2:end-1,:])
        recvbuf = zeros(size(A,2))
        MPI.Sendrecv!(sendbuf, neighbors_x[1], 1, recvbuf, neighbors_x[1], 0)
        A[end,:] = recvbuf
    end
    if neighbors_x[2] &gt;= 0
        sendbuf = copy(A[2:end-1,:])
        recvbuf = zeros(size(A,2))
        MPI.Sendrecv!(sendbuf, neighbors_x[2], 0, recvbuf, neighbors_x[2], 1)
        A[1,:] = recvbuf
    end
    if neighbors_y[1] &gt;= 0
        sendbuf = copy(A[:,2:end-1])
        recvbuf = zeros(size(A,1))
        MPI.Sendrecv!(sendbuf, neighbors_y[1], 3, recvbuf, neighbors_y[1], 2)
        A[:,end] = recvbuf
    end
    if neighbors_y[2] &gt;= 0
        sendbuf = copy(A[:,2:end-1])
        recvbuf = zeros(size(A,1))
        MPI.Sendrecv!(sendbuf, neighbors_y[2], 2, recvbuf, neighbors_y[2], 3)
        A[:,1] = recvbuf
    end
end

# MPI setup
MPI.Init()
nprocs      = MPI.Comm_size(MPI.COMM_WORLD)
dims = [0,0]
MPI.Dims_create!(nprocs, dims)
comm        = MPI.Cart_create(MPI.COMM_WORLD, dims, [0,0], 1)
me          = MPI.Comm_rank(comm)
coords      = MPI.Cart_coords(comm)
neighbors_x = MPI.Cart_shift(comm, 0, 1)
neighbors_y = MPI.Cart_shift(comm, 1, 1)

# Physics
lam        = 1.0                 # Thermal conductivity
cp_min     = 1.0                 # Minimal heat capacity
lx, ly     = 10.0, 10.0          # Length of computational domain in dimension x and y

nx, ny     = 128, 128
nt         = 10000
nx_g       = dims[1]*(nx-2) + 2
ny_g       = dims[2]*(ny-2) + 2
dx         = lx/(nx_g-1)
dy         = ly/(ny_g-1)

T     = zeros(nx,   ny)
Cp    = zeros(nx,   ny)
dTedt = zeros(nx-2, ny-2)
qTx   = zeros(nx-1, ny-2)
qTy   = zeros(nx-2, ny-1)

x0    = coords[1]*(nx-2)*dx
y0    = coords[2]*(ny-2)*dy


Cp[:] = cp_min .+ reshape([  5*exp(-((x0 + ix*dx - lx/1.5)/1.0)^2 - ((y0 + iy*dy - ly/1.5)/1.0)^2) +
                                            5*exp(-((x0 + ix*dx - lx/1.5)/1.0)^2 - ((y0 + iy*dy - ly/3.0)/1.0)^2) for ix in 1:nx, iy in 1:ny], (nx,ny))


T[:]  =          reshape([100*exp(-((x0 + ix*dx - lx/3.0)/2.0)^2 - ((y0 + iy*dy - ly/2.0)/2.0)^2) +
                                          50*exp(-((x0 + ix*dx - lx/1.5)/2.0)^2 - ((y0 + iy*dy - ly/2.0)/2.0)^2) for ix in 1:nx, iy in 1:ny], (nx,ny))

# ADIOS2
# (size and start of the local and global problem)
nxy_nohalo   = [nx-2, ny-2]
nxy_g_nohalo = [nx_g-2, ny_g-2]
start        = [coords[1]*nxy_nohalo[1], coords[2]*nxy_nohalo[2]]
T_nohalo     = zeros(nx-2, ny-2)                                  # Preallocate array for writing temperature
# (intialize ADIOS2, io, engine and define the variable temperature)
adios2_init(filename = &quot;adios2.xml&quot;, comm = comm)                 # Use the configurations defined in &quot;adios2.xml&quot;
write_setup(&quot;temperature&quot; =&gt; T, bp_filename = &quot;diffusion2D.bp&quot;)   # Define the variable &quot;temperature&quot; and open the file/stream &quot;diffusion2D.bp&quot;

# Time loop
nsteps = 50
dt     = min(dx,dy)^2*cp_min/lam/4.1
global t      = 0
tic    = time()

for it in 1:nt
    if it % (nt/nsteps) == 0                                     # Write data only nsteps times
        T_nohalo[:] = T[2:end-1, 2:end-1]                        # Copy data removing the halo
        write(T_nohalo)                                          # Add T (without halo) to variables for writing
        println(&quot;Time step &quot; * string(it) * &quot;...&quot;)
    end
    qTx[:]       = -lam*diff(T[:,2:end-1],dims=1)/dx             # Fourier&#39;s law of heat conduction: q_x   = -λ δT/δx
    qTy[:]       = -lam*diff(T[2:end-1,:],dims=2)/dy             # ...                               q_y   = -λ δT/δy
    dTedt[:]     = 1.0./Cp[2:end-1,2:end-1].*(-diff(qTx,dims=1)  # Conservation of energy:           δT/δt = 1/cₚ(-δq_x/δx
                                    /dx - diff(qTy,dims=2)/dy)   #                                               - δq_y/dy)
    T[2:end-1,2:end-1] = T[2:end-1,2:end-1] + dt*dTedt           # Update of temperature             T_new = T_old + δT/δt
    global t            = t + dt                                 # Elapsed physical time
    update_halo(T, neighbors_x, neighbors_y)                     # Update the halo of T
end

finalize_adios()
MPI.Finalize()

@printf(&quot;\ntime: %.8f\n&quot;, time() - tic)
@printf(&quot;Min. temperature: %2.2e\n&quot;, minimum(T))
@printf(&quot;Max. temperature: %2.2e\n&quot;, maximum(T))
</code></pre><p>The corresponding file can be found <a href="../../assets/examples/mpi_diffusion2D.jl">here</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../read_test/">« Reading one variable with a pre-configured XML file</a><a class="docs-footer-nextpage" href="../../api/">API reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 13 September 2023 07:44">Wednesday 13 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
